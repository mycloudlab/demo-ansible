# Basic provisioning example
- name: Ansible test
  hosts: all
  tasks:
  - name: criar vpc para aplicação pet-clinic
    ec2_vpc_net:
      name: vpc-petclinic-dev
      cidr_block: 10.10.0.0/16
      region: us-east-2
      tags:
        Name: vpc-petclinic-dev
        env: dev
    register: vpcdata


  - name: cria o gateway de internet para aplicação pet-clinic
    community.aws.ec2_vpc_igw:
      vpc_id: "{{vpcdata.vpc.id}}"
      region: us-east-2
      state: present
      tags:
        Name: igw-pet-clinic-dev
        env: dev
    register: igwdata



  - name: cria a sub rede para aplicação pet-clinic
    amazon.aws.ec2_vpc_subnet:
      state: present
      vpc_id: "{{vpcdata.vpc.id}}"
      region: us-east-2
      cidr: 10.10.0.0/16
      map_public: yes
      tags:
        Name: subnet-pet-clinic-dev
        env: dev
    register: subnetdata


  - name: cria vpc public subnet route table
    ec2_vpc_route_table:
      vpc_id: "{{ vpcdata.vpc.id }}"
      region: us-east-2
      state: present
      tags:
        Name: rtb-petclinic-dev
      subnets: [ "{{ subnetdata.subnet.id }}" ]
      # create routes
      routes:
        - dest: "0.0.0.0/0"
          gateway_id: "{{ igwdata.gateway_id }}"
    register: prtdata

  - name: ec2 security group
    amazon.aws.ec2_group:
      name: sec_group_petclinic
      description: an example EC2 group
      vpc_id: "{{vpcdata.vpc.id}}"
      region: us-east-2
      rules:
        - proto: tcp
          from_port: 80
          to_port: 80
          cidr_ip: 0.0.0.0/0
        - proto: tcp
          from_port: 22
          to_port: 22
          cidr_ip: 0.0.0.0/8
        - proto: tcp
          from_port: 443
          to_port: 443
          cidr_ip: 0.0.0.0/0

  - name: create a new ec2 key pair, returns generated private key
    amazon.aws.ec2_key:
      name: pet_clinic_key
      region: us-east-2
      key_material: "{{ lookup('file', 'pet-clinic-dev.pub') }}"
    
  - name: launching AWS instance using Ansible
    ec2:
      key_name: pet_clinic_key
      instance_type: t2.micro
      image: ami-0abcb3d13703a4978
      region: us-east-2
      wait: yes
      group: sec_group_petclinic
      count: 1
      vpc_subnet_id: "{{ subnetdata.subnet.id }}"
      assign_public_ip: yes
      
